<!DOCTYPE html>
<html>
<head>
    <link href="https://cdn.jsdelivr.net/gh/cityofnewyork/access-nyc-patterns@v0.0.11-11/dist/styles/site-default.css" type="text/css" rel="stylesheet">
    <style>
        .hideText {z-index: -1; opacity: 0; }
        .showText {opacity: 1; z-index: 100;}
        #errors{display: none;}
        #errors ul {margin: 0; padding: 0 0 0 20px;}
        #bulkSubmissionForm{position: relative;}
        #loader{position: absolute; top:0; text-align: center; background: rgba(255, 255, 255, 0.57); width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 25px; font-weight: 600; }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <div id="errors" class="alert alert-danger" role="alert"></div>

        <div class="bg-color-white screen-desktop:border border-color-grey-light screen-desktop:m-4 text-font-size-small p-4">
            <h1 class="type-h1 w-full text-font-size-larger text-color-blue-dark border-b border-color-grey-mid pb-4 mb-3">ACCESS NYC Eligibility API Bulk Processing</h1>

            <form id="bulkSubmissionForm">
                <div class="hideText" id="loader">Loading...</div>

                <div class="c-question">
                    <label class="c-question__label" for="baseurl">Base URL<span style="color:red">*</span></label>
                    <div class="c-question__container">
                        <input class="w-full" type="text" id="baseurl" placeholder="Enter Base URL" name="baseurl" maxlength="255">
                    </div>
                </div>

                <div class="c-question">
                    <label class="c-question__label" for="username">Username<span style="color:red">*</span></label>
                    <div class="c-question__container">
                        <input type="text" id="username" placeholder="Enter Username" name="username" maxlength="255">
                    </div>
                </div>

                <div class="c-question">
                    <label class="c-question__label" for="password">Password<span style="color:red">*</span></label>
                    <div class="c-question__container">
                        <input type="password" id="password" placeholder="Password" name="password" maxlength="255">
                    </div>
                </div>

                <div class="c-question">
                    <label class="c-question__label" for="newpassword">New Password</label>
                    <div class="c-question__container">
                        <p>Users must set a new password of their Cognito user pools only while doing first time authentication. Second time onward, the newly set password must be provided in the Password field.</p>
                        <input type="password" id="newpassword" placeholder="New Password" name="newPassword" maxlength="255">
                    </div>
                </div>

                <div class="c-question">
                    <label class="c-question__label" for="eligibility">Program Codes</label>
                    <div class="c-question__container">
                        <p>To only check eligibility for certain programs, add the program codes you wish you check here, separated by a comma</p>
                        <input class="w-full" id="eligibility" name="programs" maxlength="2048"></input>
                    </div>
                </div>

                <div class="c-question">
                    <label class="c-question__label" for="csv_upload">Upload File<span style="color:red">*</span></label>
                    <div class="c-question__container">
                        <input id="csv_upload" type="file" name="csvFile" accept=".csv">
                    </div>
                </div>

                <button type="submit" name="submit" class="btn btn-primary">Submit</button>
            </form>
        </div>
    </div>
<script>
    var formValues = {}
    var token
    var filename = 'response.csv'

    function setErrors(messageString, errorState) {
        var ele = document.getElementById('errors');
            ele.innerHTML = '<ul>' + messageString + '</ul>';
            ele.style.display = errorState;
    }

    function setToken(responseText) {
        try {
            token = JSON.parse(responseText).token
        }
        catch (err) {}
    }

    function sendPostRequest(url, headersObject, responseHandler, requestPayload) {
        setErrors('', 'none')
        document.getElementById('loader').className = 'showText'
        var req = new XMLHttpRequest();
        req.open('POST', url, true);
        Object.keys(headersObject).forEach(function(key) {
            req.setRequestHeader(key, headersObject[key]);
        });
        req.onreadystatechange = function() {
            document.getElementById('loader').className = 'hideText'
            responseHandler(req)
        }
        req.send(requestPayload)
    }

    function displayErrors(responseText, showPath) {
        var errorJSON
        var errorsArray = []
        try {
            errorJSON = JSON.parse(responseText).errors
            errorsArray = errorJSON.map(function(error) {
                const { elementPath, message } = error
                const errorMsg = elementPath && showPath ? message + ' Element Path: ' + elementPath + '.' : message
                return '<li>' + errorMsg + '</li>'
            })
        }
        catch (err) {}
        setErrors(errorsArray.join(''), 'block');
    }

    function bulkSubmissionHandler(req) {
        if (req.readyState === 4) {
            const status = req.status.toString()
            if (status.startsWith('4') || status.startsWith('5')) {
                displayErrors(req.responseText, true)
            }
            else if (status.startsWith('2')) {
                const blob = new Blob([req.response], {type : 'text/csv'})
                if (typeof window.navigator.msSaveBlob !== 'undefined') {
                    window.navigator.msSaveBlob(blob, filename)
                }
                else {
                    const URL = window.URL || window.webkitURL
                    const downloadUrl = URL.createObjectURL(blob)

                    const a = document.createElement('a')
                    if (typeof a.download === 'undefined') {
                        window.location = downloadUrl
                    }
                    else {
                        a.href = downloadUrl
                        a.download = filename
                        document.body.appendChild(a)
                        a.click()
                    }
                    setTimeout(() => {
                    URL.revokeObjectURL(downloadUrl)
                    }, 100) // cleanup
                }
            }
        }
    }

    function sendBulkSubmissionRequest() {
        const { baseurl, username, csvFile } = formValues
        var url = baseurl + 'bulkSubmission/import'
        if (formValues.programs) {
            var programs = formValues.programs.split(',').join('|')
            url = url + '?interestedPrograms=' + programs
        }
        var headersObject = {
            username, Authorization : token,
        }
        var formData = new FormData();
        formData.append("file", csvFile);
        sendPostRequest(url, headersObject, bulkSubmissionHandler, formData)
    }

    function authResponseHandler(req) {
        if(req.readyState === 4) {
            const status = req.status.toString()
            if (status.startsWith('4') || status.startsWith('5')) {
                displayErrors(req.responseText, false)
            }
            else if (status.startsWith('2')) {
                setToken(req.responseText)
                sendBulkSubmissionRequest()
            }
        }
    }

    document.querySelector('form').addEventListener('submit',function (e) {
        e.preventDefault()
        const formData = new FormData(e.target);
        for (var [key, value] of formData.entries()) {
            formValues[key] = value
        }
        const { baseurl, username, password, newPassword } = formValues
        console.log('programs', formValues.programs)
        var url = baseurl + 'authToken'
        var headersObject = {
            'Content-type': 'application/json',
            'Access-Control-Allow-Origin': '*',
        }
        const authPayload = { username, password }
        if (newPassword) {
            authPayload.newPassword = newPassword
        }
        sendPostRequest(url, headersObject, authResponseHandler, JSON.stringify(authPayload))
    });
</script>
</body>
</html>
